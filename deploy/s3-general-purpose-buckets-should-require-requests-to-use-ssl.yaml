AWSTemplateFormatVersion: '2010-09-09'
Description: 'Remediate S3 general purpose buckets should require requests'
Parameters:
  LogGroupName:
    Type: String
    Default: '/aws/cloudtrail'
Resources:
  RemediationDoc:
    Type: 'AWS::SSM::Document'
    Properties:
      DocumentType: 'Automation'
      Content:
        schemaVersion: '0.3'
        description: 'Fix S3 general purpose buckets should require requests'
        mainSteps:
        - name: 'CreateMetricFilter'
          action: 'aws:executeAwsApi'
          inputs:
            Service: cloudwatchlogs
            Api: PutMetricFilter
            logGroupName: !Ref LogGroupName
            filterName: 's3-general-purpose-buckets-should-require-requests-to-use-ssl'
            filterPattern: '{$.eventSource == "s3.amazonaws.com"}'
            metricTransformations:
            - metricName: 's3-general-purpose-buckets-should-require-requests-to-use-ssl'
              metricNamespace: 'SecurityHubRemediation'
              metricValue: '1'
              metricType: 'Count'